rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow create: if isAuthenticatedOwner(userId) && isValidUserCreate();
      allow read: if request.auth != null;
      allow update: if isAuthenticatedOwner(userId) && isValidUserUpdate();
      allow delete: if false;
    }

    match /chatMessages/{messageId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null &&
                      request.resource.data.userId == request.auth.uid &&
                      request.resource.data.message is string &&
                      request.resource.data.message.size() > 0 &&
                      request.resource.data.message.size() <= 250;
      allow update, delete: if false;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }

  function isAuthenticatedOwner(userId) {
    return request.auth != null && request.auth.uid == userId;
  }

  function isAdmin() {
    return request.auth != null &&
           exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.admin == 1;
  }

  function allowedUserFields() {
    return [
      'email',
      'createdAt',
      'balance',
      'totalWagered',
      'totalWon',
      'gamesPlayed',
      'diceGamesPlayed',
      'diceWins',
      'diceLosses',
      'diceBestWin',
      'plinkoGamesPlayed',
      'plinkoTotalWon',
      'plinkoBestWin',
      'blackjackHandsPlayed',
      'blackjackWins',
      'blackjackBlackjacks',
      'blackjackTotalProfit',
      'minesGamesPlayed',
      'minesCashouts',
      'minesBestMultiplier',
      'minesTotalProfit',
      'towerGamesPlayed',
      'towerCashouts',
      'towerBestMultiplier',
      'towerTotalProfit',
      'totalWager',
      'rakebackAvailable',
      'totalRakebackEarned',
      'lastRakebackClaim',
      'username',
      'admin'
    ];
  }

  function requiredUserFields() {
    return [
      'balance',
      'totalWagered',
      'totalWon',
      'gamesPlayed'
    ];
  }

  function hasAllowedKeys() {
    return request.resource.data.keys().hasOnly(allowedUserFields());
  }

  function isNonNegativeNumber(field) {
    return (request.resource.data[field] is number || request.resource.data[field] is int) &&
           request.resource.data[field] >= 0;
  }

  function isNonNegativeInt(field) {
    return request.resource.data[field] is int &&
           request.resource.data[field] >= 0;
  }

  function isNumber(field) {
    return request.resource.data[field] is number;
  }

  function isValidOptionalNumber(field) {
    return !request.resource.data.keys().hasAny([field]) ||
           request.resource.data[field] == null ||
           (request.resource.data[field] is number && request.resource.data[field] >= 0) ||
           (request.resource.data[field] is int && request.resource.data[field] >= 0);
  }

  function isValidOptionalInt(field) {
    return !request.resource.data.keys().hasAny([field]) ||
           request.resource.data[field] == null ||
           (request.resource.data[field] is int && request.resource.data[field] >= 0);
  }

  function hasValidNumberFields() {
    return (!request.resource.data.keys().hasAny(['balance']) || isNonNegativeNumber('balance')) &&
           (!request.resource.data.keys().hasAny(['totalWagered']) || isNonNegativeNumber('totalWagered')) &&
           (!request.resource.data.keys().hasAny(['totalWon']) || isNonNegativeNumber('totalWon')) &&
           (!request.resource.data.keys().hasAny(['gamesPlayed']) || isNonNegativeInt('gamesPlayed')) &&
           isValidOptionalInt('diceGamesPlayed') &&
           isValidOptionalInt('diceWins') &&
           isValidOptionalInt('diceLosses') &&
           isValidOptionalNumber('diceBestWin') &&
           isValidOptionalInt('plinkoGamesPlayed') &&
           isValidOptionalNumber('plinkoTotalWon') &&
           isValidOptionalNumber('plinkoBestWin') &&
           isValidOptionalInt('blackjackHandsPlayed') &&
           isValidOptionalInt('blackjackWins') &&
           isValidOptionalInt('blackjackBlackjacks') &&
           isValidOptionalNumber('blackjackTotalProfit') &&
           isValidOptionalInt('minesGamesPlayed') &&
           isValidOptionalInt('minesCashouts') &&
           isValidOptionalNumber('minesBestMultiplier') &&
           isValidOptionalNumber('minesTotalProfit') &&
           isValidOptionalInt('towerGamesPlayed') &&
           isValidOptionalInt('towerCashouts') &&
           isValidOptionalNumber('towerBestMultiplier') &&
           isValidOptionalNumber('towerTotalProfit') &&
           isValidOptionalNumber('totalWager') &&
           isValidOptionalNumber('rakebackAvailable') &&
           isValidOptionalNumber('totalRakebackEarned');
  }

  function hasValidCreateMetadata() {
    return (request.resource.data.email == null ||
            (request.resource.data.email is string &&
             (request.auth.token.email == null ||
              request.auth.token.email == request.resource.data.email)));
  }

  function hasValidAdminField() {
    return !request.resource.data.keys().hasAny(['admin']) ||
           (request.resource.data.admin is int &&
            (request.resource.data.admin == 0 || request.resource.data.admin == 1));
  }

  function hasValidUsernameField() {
    return !request.resource.data.keys().hasAny(['username']) ||
           request.resource.data.username == null ||
           (request.resource.data.username is string &&
            request.resource.data.username.size() >= 0 &&
            request.resource.data.username.size() <= 16);
  }

  function hasValidRakebackClaimField() {
    return !request.resource.data.keys().hasAny(['lastRakebackClaim']) ||
           request.resource.data.lastRakebackClaim == null ||
           request.resource.data.lastRakebackClaim is string;
  }

  function hasValidCreatedAtField() {
    return !request.resource.data.keys().hasAny(['createdAt']) ||
           (request.resource.data.createdAt is string);
  }

  function canModifyAdminField() {
    return !request.resource.data.keys().hasAny(['admin']) ||
           (request.resource.data.admin == 0 && !resource.data.keys().hasAny(['admin'])) ||
           (resource.data.keys().hasAny(['admin']) && resource.data.admin == request.resource.data.admin) ||
           isAdmin();
  }

  function isValidUserCreate() {
    return hasAllowedKeys() &&
           hasValidNumberFields() &&
           hasValidCreateMetadata() &&
           hasValidAdminField() &&
           hasValidUsernameField() &&
           hasValidRakebackClaimField() &&
           hasValidCreatedAtField() &&
           (!request.resource.data.keys().hasAny(['admin']) || request.resource.data.admin == 0);
  }

  function isValidUserUpdate() {
    return hasAllowedKeys() &&
           hasValidNumberFields() &&
           hasValidAdminField() &&
           hasValidUsernameField() &&
           hasValidRakebackClaimField() &&
           hasValidCreatedAtField() &&
           canModifyAdminField();
  }
}
